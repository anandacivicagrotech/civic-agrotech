<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Dashboard - Prototype</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 0.95rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .card h2 {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.5rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-size: 0.95rem;
        }

        .metric-value {
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .metric-value.highlight {
            color: #667eea;
            font-size: 1.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }

        .large-chart {
            grid-column: 1 / -1;
        }

        .filter-section {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            color: #666;
            font-size: 0.85rem;
            font-weight: 600;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #667eea;
        }

        .cost-breakdown {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .cost-item-label {
            color: #666;
        }

        .cost-item-value {
            font-weight: bold;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .greenhouse-section {
            margin-top: 25px;
        }

        .greenhouse-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            color: #666;
        }

        .tab-button:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .greenhouse-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .greenhouse-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .greenhouse-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .greenhouse-card.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .greenhouse-summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
            position: relative;
        }

        .greenhouse-summary-card::after {
            content: '‚Üí';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: #667eea;
            opacity: 0;
            transition: opacity 0.3s, right 0.3s;
        }

        .greenhouse-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
            background: #f8f9ff;
        }

        .greenhouse-summary-card:hover::after {
            opacity: 1;
            right: 15px;
        }

        .greenhouse-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .greenhouse-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: #333;
        }

        .section-title {
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .section-title h2 {
            color: #333;
            font-size: 1.4rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .greenhouse-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .greenhouse-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }

            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .close {
            font-size: 2rem;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Production Dashboard</h1>
            <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</p>
        </header>

        <div class="filter-section">
            <div class="filter-group">
                <label for="yearFilter">‡∏õ‡∏µ</label>
                <select id="yearFilter" onchange="updateDashboard()">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="monthFilter">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                <select id="monthFilter" onchange="updateDashboard()">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                    <option value="11" selected>‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="vegetableFilter">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</label>
                <select id="vegetableFilter" onchange="updateDashboard()">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="lettuce">‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°</option>
                    <option value="kale">‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤</option>
                    <option value="spinach">‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°</option>
                    <option value="basil">‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤</option>
                </select>
            </div>
            <button onclick="openInputModal()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; white-space: nowrap;">
                üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï
            </button>
        </div>

        <div class="dashboard-grid">
            <!-- Overview Card -->
            <div class="card">
                <h2>‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</h2>
                <div class="metric">
                    <span class="metric-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°</span>
                    <span class="metric-value highlight" id="totalWeight">1,245 kg</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</span>
                    <span class="metric-value" id="totalBatches">24 ‡∏£‡∏≠‡∏ö</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≠‡∏ö</span>
                    <span class="metric-value" id="avgPerBatch">51.9 kg</span>
                </div>
            </div>

            <!-- Energy Card -->
            <div class="card">
                <h2>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</h2>
                <div class="metric">
                    <span class="metric-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏ß‡∏°</span>
                    <span class="metric-value highlight" id="totalEnergy">18,500 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ï‡πà‡∏≠ kg</span>
                    <span class="metric-value" id="energyPerKg">14.86 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° (IoT)</span>
                    <span class="metric-value" id="totalKwh">3,364 kWh</span>
                </div>
            </div>

            <!-- Efficiency Card -->
            <div class="card">
                <h2>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</h2>
                <div class="metric">
                    <span class="metric-label">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠ kg</span>
                    <span class="metric-value highlight" id="kwhPerKg">2.70 kWh/kg</span>
                </div>
            </div>

            <!-- Production Trend Chart -->
            <div class="card large-chart">
                <h2>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h2>
                <div class="chart-container">
                    <canvas id="productionTrendChart"></canvas>
                </div>
            </div>

        </div>

        <!-- Charts Grid (1 column) -->
        <div class="card" style="margin-bottom: 25px;">
            <h2>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="vegetablePieChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="costPieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Vegetable Cost Detail Table -->
        <div class="card" style="margin-bottom: 25px;">
            <h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</h2>
            <div style="overflow-x: auto; margin-top: 15px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e0e0e0;">
                            <th style="text-align: left; padding: 12px; color: #666; font-weight: 600;">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</th>
                            <th style="text-align: right; padding: 12px; color: #666; font-weight: 600;">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (kg)</th>
                            <th style="text-align: right; padding: 12px; color: #666; font-weight: 600;">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (kWh)</th>
                            <th style="text-align: right; padding: 12px; color: #666; font-weight: 600;">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (kWh/kg)</th>
                            <th style="text-align: right; padding: 12px; color: #666; font-weight: 600;">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (‡∏ø/kg)</th>
                        </tr>
                    </thead>
                    <tbody id="vegetableCostTableBody">
                        <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡πÇ‡∏î‡∏¢ JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Greenhouse Section -->
        <div class="greenhouse-section">
            <div class="section-title">
                <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏á‡∏õ‡∏•‡∏π‡∏Å</h2>
                <p style="color: #666; font-size: 0.9rem; margin-top: 8px;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</p>
            </div>

            <!-- Greenhouse Summary Cards -->
            <div class="greenhouse-grid" id="greenhouseSummaryContainer" style="margin-bottom: 25px;">
                <div id="gh1-summary" class="greenhouse-summary-card">
                    <!-- Will be populated by JS -->
                </div>
                <div id="gh2-summary" class="greenhouse-summary-card">
                    <!-- Will be populated by JS -->
                </div>
                <div id="gh3-summary" class="greenhouse-summary-card">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Individual Greenhouse Dashboard -->
            <div id="greenhouseDetailView">
                <div style="margin-bottom: 20px;">
                    <button class="tab-button" onclick="backToOverview()" style="display: inline-flex; align-items: center; gap: 8px;">
                        <span>‚Üê</span> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                        </button>
                    </div>

                </div>

                <!-- Individual Greenhouse Dashboard Content -->
                <div id="greenhouseDetailContent" style="display: none;">
                    <h2 id="selectedGreenhouseName" style="margin-bottom: 20px;">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏ô 1</h2>

                    <!-- Metrics -->
                    <div class="dashboard-grid" style="margin-bottom: 25px;">
                        <div class="card">
                            <h2>‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</h2>
                            <div id="ghDetailProduction"></div>
                        </div>
                        <div class="card">
                            <h2>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (IoT)</h2>
                            <div id="ghDetailEnergy"></div>
                        </div>
                        <div class="card">
                            <h2>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</h2>
                            <div id="ghDetailEfficiency"></div>
                        </div>
                    </div>

                    <!-- Crop Chart -->
                    <div class="card" style="margin-bottom: 25px;">
                        <h2>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</h2>
                        <div class="chart-container">
                            <canvas id="greenhouseCropChart"></canvas>
                        </div>
                    </div>

                    <!-- Harvest Records Table -->
                    <div class="card">
                        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</h2>
                        <div style="overflow-x: auto; margin-top: 15px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                        <th style="padding: 12px; text-align: left;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</th>
                                        <th style="padding: 12px; text-align: left;">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</th>
                                        <th style="padding: 12px; text-align: right;">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</th>
                                        <th style="padding: 12px; text-align: right;">‡∏ñ‡∏≤‡∏î</th>
                                        <th style="padding: 12px; text-align: right;">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏ï‡∏£.‡∏°.)</th>
                                        <th style="padding: 12px; text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
                                        <th style="padding: 12px; text-align: right;">kWh</th>
                                        <th style="padding: 12px; text-align: right;">kWh/kg</th>
                                    </tr>
                                </thead>
                                <tbody id="harvestRecordsTable">
                                    <!-- Will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Modal -->
    <div id="inputModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</h2>
                <span class="close" onclick="closeInputModal()">&times;</span>
            </div>
            <form id="productionForm" onsubmit="submitProduction(event)">
                <div class="form-group">
                    <label for="harvestDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß *</label>
                    <input type="date" id="harvestDate" required oninput="calculateEnergy()">
                </div>
                <div class="form-group">
                    <label for="greenhouse">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏ô *</label>
                    <select id="greenhouse" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏ô --</option>
                        <option value="gh1">‡πÇ‡∏£‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà 1</option>
                        <option value="gh2">‡πÇ‡∏£‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà 2</option>
                        <option value="gh3">‡πÇ‡∏£‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà 3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trayType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ñ‡∏≤‡∏î *</label>
                    <select id="trayType" required onchange="updateTrayInfo()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ñ‡∏≤‡∏î --</option>
                        <option value="standard">Hydroponic Tray 112√ó65 cm (0.73 ‡∏ï‡∏£.‡∏°., 24 ‡∏´‡∏•‡∏∏‡∏°)</option>
                        <option value="nft2m">Hydroponic Tray 2m NFT/DFT (2.66 ‡∏ï‡∏£.‡∏°., 100 ‡∏´‡∏•‡∏∏‡∏°)</option>
                        <option value="ebb2m">Ebb & Flow Tray 2m (2.60 ‡∏ï‡∏£.‡∏°., 100 ‡∏´‡∏•‡∏∏‡∏°)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trayCount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏≤‡∏î *</label>
                    <input type="number" id="trayCount" min="1" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 30" oninput="updateTrayInfo()">
                    <small style="color: #999; font-size: 0.85rem; margin-top: 4px; display: block;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</small>
                </div>
                <div class="form-group">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="fullHoles" checked onchange="toggleHolesInput()" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                        <label for="fullHoles" style="margin: 0; cursor: pointer;">‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏•‡∏∏‡∏°</label>
                    </div>
                    <div id="holesInputGroup" style="display: none;">
                        <label for="holesUsed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏∏‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ *</label>
                        <input type="number" id="holesUsed" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2400" oninput="updateTrayInfo()">
                        <small style="color: #999; font-size: 0.85rem; margin-top: 4px; display: block;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡∏à‡∏£‡∏¥‡∏á</small>
                    </div>
                </div>
                <div class="form-group" style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°:</span>
                        <span id="totalArea" style="color: #667eea; font-weight: 600;">-- ‡∏ï‡∏£.‡∏°.</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏∏‡∏°‡∏£‡∏ß‡∏°:</span>
                        <span id="totalHoles" style="color: #667eea; font-weight: 600;">-- ‡∏´‡∏•‡∏∏‡∏°</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</span>
                        <span id="actualArea" style="color: #4CAF50; font-weight: 600;">-- ‡∏ï‡∏£.‡∏°.</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="vegetableType">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å *</label>
                    <select id="vegetableType" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å --</option>
                        <option value="lettuce">‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°</option>
                        <option value="kale">‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤</option>
                        <option value="spinach">‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°</option>
                        <option value="basil">‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ (kg) *</label>
                    <input type="number" id="weight" step="0.1" min="0" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 45.5" oninput="calculateEnergy()">
                </div>
                <div class="form-group">
                    <label for="plantDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å *</label>
                    <input type="date" id="plantDate" required oninput="calculateEnergy()">
                </div>
                <div id="energyPreview" class="form-group" style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107; display: none;">
                    <h4 style="margin: 0 0 8px 0; font-size: 0.95rem; color: #856404;">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å:</span>
                        <span id="previewGrowthDays" style="color: #856404; font-weight: 600;">-- ‡∏ß‡∏±‡∏ô</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666; font-size: 0.9rem;">‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏£‡∏ß‡∏°:</span>
                        <span id="previewTotalEnergy" style="color: #856404; font-weight: 600;">-- kWh</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û:</span>
                        <span id="previewKwhPerKg" style="color: #856404; font-weight: 600;">-- kWh/kg</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢:</span>
                        <span id="previewKgPerKwh" style="color: #856404; font-weight: 600;">-- kg/kWh</span>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeInputModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let charts = {};
        let selectedGreenhouse = null;

        // Tray specifications (used by multiple functions)
        const traySpecs = {
            standard: { area: 0.73, holes: 24, name: 'Hydroponic Tray 112√ó65 cm' },
            nft2m: { area: 2.66, holes: 100, name: 'Hydroponic Tray 2m NFT/DFT' },
            ebb2m: { area: 2.60, holes: 100, name: 'Ebb & Flow Tray 2m' }
        };

        // Mock Data
        const mockData = {
            production: {
                totalWeight: 1245,
                crops: 24,
                energyCost: 18500,
                laborCost: 23040,
                materialCost: 14750
            },
            monthlyTrend: [
                { month: '‡∏°‡∏¥.‡∏¢.', weight: 980, crops: 20 },
                { month: '‡∏Å.‡∏Ñ.', weight: 1050, crops: 21 },
                { month: '‡∏™.‡∏Ñ.', weight: 1120, crops: 22 },
                { month: '‡∏Å.‡∏¢.', weight: 1180, crops: 23 },
                { month: '‡∏ï.‡∏Ñ.', weight: 1200, crops: 24 },
                { month: '‡∏û.‡∏¢.', weight: 1245, crops: 24 }
            ],
            vegetables: [
                {
                    name: '‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°',
                    weight: 450,
                    color: '#4CAF50',
                    trayType: 'nft2m',
                    trayCount: 30,
                    fullHoles: true,
                    holesUsed: 3000,
                    growthDays: 35
                },
                {
                    name: '‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤',
                    weight: 380,
                    color: '#2196F3',
                    trayType: 'nft2m',
                    trayCount: 25,
                    fullHoles: true,
                    holesUsed: 2500,
                    growthDays: 30
                },
                {
                    name: '‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°',
                    weight: 280,
                    color: '#FF9800',
                    trayType: 'standard',
                    trayCount: 30,
                    fullHoles: false,
                    holesUsed: 600,
                    growthDays: 25
                },
                {
                    name: '‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤',
                    weight: 135,
                    color: '#9C27B0',
                    trayType: 'standard',
                    trayCount: 20,
                    fullHoles: true,
                    holesUsed: 480,
                    growthDays: 28
                }
            ],
            greenhouses: [
                {
                    id: 'gh1',
                    name: '‡πÇ‡∏£‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà 1',
                    production: 425,
                    crops: 8,
                    energyUsage: 6200, // kWh (from IoT)
                    energyCost: 6200, // ‡∏ö‡∏≤‡∏ó
                    status: 'active',
                    currentCrops: [
                        {
                            name: '‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°',
                            weight: 180,
                            trayType: 'nft2m',
                            trayCount: 12,
                            fullHoles: true,
                            holesUsed: 1200,
                            growthDays: 35,
                            plantDate: '2024-11-01',
                            harvestDate: '2024-12-06'
                        },
                        {
                            name: '‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤',
                            weight: 150,
                            trayType: 'nft2m',
                            trayCount: 10,
                            fullHoles: true,
                            holesUsed: 1000,
                            growthDays: 30,
                            plantDate: '2024-11-06',
                            harvestDate: '2024-12-06'
                        },
                        {
                            name: '‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°',
                            weight: 95,
                            trayType: 'standard',
                            trayCount: 15,
                            fullHoles: false,
                            holesUsed: 300,
                            growthDays: 25,
                            plantDate: '2024-11-11',
                            harvestDate: '2024-12-06'
                        }
                    ]
                },
                {
                    id: 'gh2',
                    name: '‡πÇ‡∏£‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà 2',
                    production: 390,
                    crops: 8,
                    energyUsage: 5800,
                    energyCost: 5800,
                    status: 'active',
                    currentCrops: [
                        {
                            name: '‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°',
                            weight: 160,
                            trayType: 'nft2m',
                            trayCount: 10,
                            fullHoles: true,
                            holesUsed: 1000,
                            growthDays: 35,
                            plantDate: '2024-11-01',
                            harvestDate: '2024-12-06'
                        },
                        {
                            name: '‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤',
                            weight: 140,
                            trayType: 'nft2m',
                            trayCount: 9,
                            fullHoles: true,
                            holesUsed: 900,
                            growthDays: 30,
                            plantDate: '2024-11-06',
                            harvestDate: '2024-12-06'
                        },
                        {
                            name: '‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤',
                            weight: 90,
                            trayType: 'standard',
                            trayCount: 12,
                            fullHoles: true,
                            holesUsed: 288,
                            growthDays: 28,
                            plantDate: '2024-11-08',
                            harvestDate: '2024-12-06'
                        }
                    ]
                },
                {
                    id: 'gh3',
                    name: '‡πÇ‡∏£‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà 3',
                    production: 430,
                    crops: 8,
                    energyUsage: 6500,
                    energyCost: 6500,
                    status: 'active',
                    currentCrops: [
                        {
                            name: '‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°',
                            weight: 110,
                            trayType: 'nft2m',
                            trayCount: 8,
                            fullHoles: true,
                            holesUsed: 800,
                            growthDays: 35,
                            plantDate: '2024-11-01',
                            harvestDate: '2024-12-06'
                        },
                        {
                            name: '‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤',
                            weight: 90,
                            trayType: 'nft2m',
                            trayCount: 6,
                            fullHoles: true,
                            holesUsed: 600,
                            growthDays: 30,
                            plantDate: '2024-11-06',
                            harvestDate: '2024-12-06'
                        },
                        {
                            name: '‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°',
                            weight: 185,
                            trayType: 'standard',
                            trayCount: 15,
                            fullHoles: false,
                            holesUsed: 300,
                            growthDays: 25,
                            plantDate: '2024-11-11',
                            harvestDate: '2024-12-06'
                        },
                        {
                            name: '‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤',
                            weight: 45,
                            trayType: 'standard',
                            trayCount: 8,
                            fullHoles: true,
                            holesUsed: 192,
                            growthDays: 28,
                            plantDate: '2024-11-08',
                            harvestDate: '2024-12-06'
                        }
                    ]
                }
            ]
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å (Area-Time Based Allocation)
        function calculateEnergyCostPerVegetable() {
            const totalEnergyCost = mockData.production.energyCost; // 18,500 ‡∏ö‡∏≤‡∏ó
            const electricityRate = 5.5; // ‡∏ø/kWh (‡∏™‡∏°‡∏°‡∏ï‡∏¥)
            const totalEnergyKwh = totalEnergyCost / electricityRate; // kWh

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Area-Time Units ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ú‡∏±‡∏Å
            const areaTimeUnits = mockData.vegetables.map(v => {
                const spec = traySpecs[v.trayType];
                const totalArea = spec.area * v.trayCount;
                const totalHoles = spec.holes * v.trayCount;

                // Calculate actual area based on holes used
                let actualArea = totalArea;
                if (!v.fullHoles && v.holesUsed < totalHoles) {
                    actualArea = (v.holesUsed / totalHoles) * totalArea;
                }

                return {
                    name: v.name,
                    color: v.color,
                    weight: v.weight,
                    trayType: v.trayType,
                    trayCount: v.trayCount,
                    area: actualArea,
                    growthDays: v.growthDays,
                    areaTime: actualArea * v.growthDays
                };
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Total Area-Time Units
            const totalAreaTime = areaTimeUnits.reduce((sum, v) => sum + v.areaTime, 0);

            // ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô
            const allocatedCosts = areaTimeUnits.map(v => ({
                name: v.name,
                color: v.color,
                weight: v.weight,
                area: v.area,
                growthDays: v.growthDays,
                areaTime: v.areaTime,
                ratio: v.areaTime / totalAreaTime,
                energyKwh: (v.areaTime / totalAreaTime) * totalEnergyKwh,
                energyCost: (v.areaTime / totalAreaTime) * totalEnergyCost,
                energyKwhPerKg: ((v.areaTime / totalAreaTime) * totalEnergyKwh) / v.weight,
                energyCostPerKg: ((v.areaTime / totalAreaTime) * totalEnergyCost) / v.weight
            }));

            return allocatedCosts;
        }

        function initCharts() {
            console.log('üìà initCharts() called');
            console.log('Chart.js loaded?', typeof Chart !== 'undefined');

            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js is not loaded!');
                alert('Error: Chart.js library failed to load. Please check your internet connection.');
                return;
            }

            // Production Trend Chart
            const trendCtx = document.getElementById('productionTrendChart').getContext('2d');
            charts.productionTrend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: mockData.monthlyTrend.map(d => d.month),
                    datasets: [{
                        label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (kg)',
                        data: mockData.monthlyTrend.map(d => d.weight),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' kg';
                                }
                            }
                        }
                    }
                }
            });

            // Vegetable Pie Chart
            const vegCtx = document.getElementById('vegetablePieChart').getContext('2d');
            charts.vegetablePie = new Chart(vegCtx, {
                type: 'doughnut',
                data: {
                    labels: mockData.vegetables.map(v => v.name),
                    datasets: [{
                        data: mockData.vegetables.map(v => v.weight),
                        backgroundColor: mockData.vegetables.map(v => v.color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const weight = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((weight / total) * 100).toFixed(1);
                                    return context.label + ': ' + weight + ' kg (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Cost Breakdown Chart - ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å
            const costCtx = document.getElementById('costPieChart').getContext('2d');
            const vegetableCosts = calculateEnergyCostPerVegetable();

            charts.costPie = new Chart(costCtx, {
                type: 'doughnut',
                data: {
                    labels: vegetableCosts.map(v => v.name),
                    datasets: [{
                        data: vegetableCosts.map(v => v.energyCost),
                        backgroundColor: vegetableCosts.map(v => v.color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const veg = vegetableCosts[context.dataIndex];
                                    return [
                                        veg.name + ': ' + veg.energyKwh.toFixed(2) + ' kWh',
                                        '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ' + veg.energyCost.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó',
                                        '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠ kg: ' + veg.energyCostPerKg.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó/kg',
                                        '‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï: ' + veg.weight + ' kg',
                                        '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô: ' + (veg.ratio * 100).toFixed(1) + '%'
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderVegetableCostTable() {
            console.log('üå± renderVegetableCostTable() called');
            const vegetableCosts = calculateEnergyCostPerVegetable();
            console.log('Vegetable costs:', vegetableCosts);

            const tbody = document.getElementById('vegetableCostTableBody');
            console.log('Table body element:', tbody);

            let html = '';
            vegetableCosts.forEach((veg) => {
                html += `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 12px; font-weight: 600;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: ${veg.color}; border-radius: 50%; margin-right: 8px;"></span>
                            ${veg.name}
                        </td>
                        <td style="text-align: right; padding: 12px;">${veg.weight} kg</td>
                        <td style="text-align: right; padding: 12px;">${veg.energyKwh.toFixed(2)}</td>
                        <td style="text-align: right; padding: 12px;">${veg.energyKwhPerKg.toFixed(2)}</td>
                        <td style="text-align: right; padding: 12px; font-weight: 600; color: #667eea;">${veg.energyCostPerKg.toFixed(2)}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function updateMetrics() {
            const totalWeight = mockData.production.totalWeight;
            const crops = mockData.production.crops;
            const electricityRate = 5.5; // ‡∏ø/kWh
            const totalEnergyKwh = mockData.production.energyCost / electricityRate;

            document.getElementById('totalWeight').textContent = totalWeight.toLocaleString() + ' kg';
            document.getElementById('totalBatches').textContent = crops + ' ‡∏£‡∏≠‡∏ö';
            document.getElementById('avgPerBatch').textContent = (totalWeight / crops).toFixed(1) + ' kg';

            document.getElementById('totalEnergy').textContent = mockData.production.energyCost.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('energyPerKg').textContent = (mockData.production.energyCost / totalWeight).toFixed(2) + ' ‡∏ö‡∏≤‡∏ó';

            document.getElementById('totalKwh').textContent = totalEnergyKwh.toLocaleString() + ' kWh';
            document.getElementById('kwhPerKg').textContent = (totalEnergyKwh / totalWeight).toFixed(2) + ' kWh/kg';
        }

        function updateDashboard() {
            // In a real app, this would fetch filtered data
            console.log('Filters updated:', {
                year: document.getElementById('yearFilter').value,
                month: document.getElementById('monthFilter').value,
                vegetable: document.getElementById('vegetableFilter').value
            });

            // For now, just update with the same data
            updateMetrics();
        }

        // Render greenhouse summary cards
        function renderGreenhouseSummaryCards() {
            console.log('üè≠ renderGreenhouseSummaryCards() called');

            mockData.greenhouses.forEach(gh => {
                const container = document.getElementById(`${gh.id}-summary`);
                if (!container) return;

                const avgPerCrop = (gh.production / gh.crops).toFixed(1);
                const energyPerKg = (gh.energyCost / gh.production).toFixed(2);

                container.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-size: 1.1rem; font-weight: bold; color: #333;">
                            ${gh.name}
                        </div>
                        <div style="color: #667eea; font-size: 0.85rem; background: #f0f3ff; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                            ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</span>
                        <span style="font-weight: 600; color: #333;">${gh.production} kg</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</span>
                        <span style="font-weight: 600; color: #333;">${gh.crops} ‡∏£‡∏≠‡∏ö</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span style="color: #666; font-size: 0.9rem;">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≠‡∏ö</span>
                        <span style="font-weight: 600; color: #667eea;">${avgPerCrop} kg</span>
                    </div>
                `;

                // Add click handler
                container.onclick = () => viewGreenhouseDetail(gh.id);
            });
        }

        // OLD function - keep for now
        function renderGreenhouseCards() {
            console.log('üè≠ renderGreenhouseCards() called (OLD - deprecated)');
            // Removing old implementation
            return;

            let allCardsHTML = '';
            let selectorCardsHTML = '';

            mockData.greenhouses.forEach(gh => {
                const avgPerCrop = (gh.production / gh.crops).toFixed(1);
                const energyPerKg = (gh.energyCost / gh.production).toFixed(2);

                // Card for "All View" - can switch to individual view
                const allViewCardHTML = `
                    <div class="greenhouse-card" onclick="selectGreenhouse('${gh.id}', true)">
                        <div class="greenhouse-name">
                            ${gh.name}
                        </div>
                        <div class="greenhouse-stats">
                            <div class="stat-row">
                                <span class="stat-label">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</span>
                                <span class="stat-value">${gh.production} kg</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</span>
                                <span class="stat-value">${gh.crops} ‡∏£‡∏≠‡∏ö</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (IoT)</span>
                                <span class="stat-value">${gh.energyUsage.toLocaleString()} kWh</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ï‡πà‡∏≠ kg</span>
                                <span class="stat-value">${energyPerKg} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                        </div>
                    </div>
                `;

                // Card for "Individual View" - just selects without switching view
                const selectorCardHTML = `
                    <div class="greenhouse-card" onclick="selectGreenhouse('${gh.id}', false)">
                        <div class="greenhouse-name">
                            ${gh.name}
                        </div>
                        <div class="greenhouse-stats">
                            <div class="stat-row">
                                <span class="stat-label">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</span>
                                <span class="stat-value">${gh.production} kg</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</span>
                                <span class="stat-value">${gh.crops} ‡∏£‡∏≠‡∏ö</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (IoT)</span>
                                <span class="stat-value">${gh.energyUsage.toLocaleString()} kWh</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ï‡πà‡∏≠ kg</span>
                                <span class="stat-value">${energyPerKg} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                        </div>
                    </div>
                `;

                allCardsHTML += allViewCardHTML;
                selectorCardsHTML += selectorCardHTML;
            });

            container.innerHTML = allCardsHTML;
            selectorContainer.innerHTML = selectorCardsHTML;
        }

        function showGreenhouseView(view) {
            const allView = document.getElementById('greenhouseViewAll');
            const individualView = document.getElementById('greenhouseViewIndividual');
            const tabs = document.querySelectorAll('.greenhouse-tabs .tab-button');

            tabs.forEach(tab => tab.classList.remove('active'));

            if (view === 'all') {
                allView.style.display = 'grid';
                individualView.style.display = 'none';
                tabs[0].classList.add('active');

                // Reset individual view
                document.getElementById('selectedGreenhouseData').style.display = 'none';
                document.getElementById('greenhouseSelector').style.display = 'block';
                selectedGreenhouse = null;
            } else {
                allView.style.display = 'none';
                individualView.style.display = 'block';
                tabs[1].classList.add('active');

                // Show selector by default when switching to individual view
                document.getElementById('selectedGreenhouseData').style.display = 'none';
                document.getElementById('greenhouseSelector').style.display = 'block';
            }
        }

        function selectGreenhouse(ghId, switchView = false) {
            selectedGreenhouse = mockData.greenhouses.find(gh => gh.id === ghId);

            if (!selectedGreenhouse) return;

            // Hide selector and show data section
            document.getElementById('greenhouseSelector').style.display = 'none';
            document.getElementById('selectedGreenhouseData').style.display = 'block';

            // Update selected greenhouse name
            document.getElementById('selectedGreenhouseName').innerHTML = selectedGreenhouse.name;

            // Update details
            const avgPerCrop = (selectedGreenhouse.production / selectedGreenhouse.crops).toFixed(1);
            const energyPerKg = (selectedGreenhouse.energyCost / selectedGreenhouse.production).toFixed(2);

            document.getElementById('selectedGreenhouseDetails').innerHTML = `
                <div class="metric">
                    <span class="metric-label">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</span>
                    <span class="metric-value">${selectedGreenhouse.production} kg</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</span>
                    <span class="metric-value">${selectedGreenhouse.crops} ‡∏£‡∏≠‡∏ö</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≠‡∏ö</span>
                    <span class="metric-value">${avgPerCrop} kg</span>
                </div>
            `;

            // Update energy details (from IoT)
            document.getElementById('greenhouseEnergyDetails').innerHTML = `
                <div class="metric">
                    <span class="metric-label">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (IoT)</span>
                    <span class="metric-value highlight">${selectedGreenhouse.energyUsage.toLocaleString()} kWh</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏ß‡∏°</span>
                    <span class="metric-value">${selectedGreenhouse.energyCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ï‡πà‡∏≠ kg</span>
                    <span class="metric-value">${energyPerKg} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                    <span class="badge success">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</span>
                </div>
            `;

            // Update crop chart for this greenhouse
            updateGreenhouseCropChart();

            // Switch to individual view if requested
            if (switchView) {
                showGreenhouseView('individual');
            }
        }

        function backToGreenhouseList() {
            // Hide data section and show selector
            document.getElementById('selectedGreenhouseData').style.display = 'none';
            document.getElementById('greenhouseSelector').style.display = 'block';
            selectedGreenhouse = null;
        }

        function updateGreenhouseCropChart() {
            if (!selectedGreenhouse) return;

            const ctx = document.getElementById('greenhouseCropChart').getContext('2d');

            // Destroy existing chart if it exists
            if (charts.greenhouseCrop) {
                charts.greenhouseCrop.destroy();
            }

            const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0'];

            charts.greenhouseCrop = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: selectedGreenhouse.currentCrops.map(c => c.name),
                    datasets: [{
                        label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)',
                        data: selectedGreenhouse.currentCrops.map(c => c.weight),
                        backgroundColor: colors.slice(0, selectedGreenhouse.currentCrops.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' kg';
                                }
                            }
                        }
                    }
                }
            });
        }

        // NEW FUNCTIONS for revised UI

        // View detailed dashboard for specific greenhouse
        function viewGreenhouseDetail(ghId) {
            console.log(`üìä Viewing detail for ${ghId}`);
            selectedGreenhouse = mockData.greenhouses.find(gh => gh.id === ghId);
            if (!selectedGreenhouse) return;

            // Hide summary cards, show detail view
            document.querySelectorAll('.greenhouse-summary-card').forEach(card => card.parentElement.style.display = 'none');
            document.getElementById('greenhouseDetailView').querySelector('button').style.display = 'flex';
            document.getElementById('greenhouseDetailContent').style.display = 'block';

            // Update title
            document.getElementById('selectedGreenhouseName').textContent = selectedGreenhouse.name;

            // Update metrics
            const avgPerCrop = (selectedGreenhouse.production / selectedGreenhouse.crops).toFixed(1);
            const electricityRate = 5.5;
            const energyKwh = selectedGreenhouse.energyUsage;
            const kwhPerKg = (energyKwh / selectedGreenhouse.production).toFixed(2);

            document.getElementById('ghDetailProduction').innerHTML = `
                <div class="metric">
                    <span class="metric-label">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</span>
                    <span class="metric-value highlight">${selectedGreenhouse.production} kg</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</span>
                    <span class="metric-value">${selectedGreenhouse.crops} ‡∏£‡∏≠‡∏ö</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≠‡∏ö</span>
                    <span class="metric-value">${avgPerCrop} kg</span>
                </div>
            `;

            document.getElementById('ghDetailEnergy').innerHTML = `
                <div class="metric">
                    <span class="metric-label">‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏£‡∏ß‡∏° (IoT)</span>
                    <span class="metric-value highlight">${energyKwh.toLocaleString()} kWh</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏ß‡∏°</span>
                    <span class="metric-value">${selectedGreenhouse.energyCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                </div>
            `;

            document.getElementById('ghDetailEfficiency').innerHTML = `
                <div class="metric">
                    <span class="metric-label">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</span>
                    <span class="metric-value highlight">${kwhPerKg} kWh/kg</span>
                </div>
                <div class="metric">
                    <span class="metric-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü/kg</span>
                    <span class="metric-value">${(selectedGreenhouse.energyCost / selectedGreenhouse.production).toFixed(2)} ‡∏ø/kg</span>
                </div>
            `;

            // Render crop chart
            renderGreenhouseCropChart();

            // Render harvest records table
            renderHarvestRecordsTable();
        }

        // Back to overview
        function backToOverview() {
            document.querySelectorAll('.greenhouse-summary-card').forEach(card => card.parentElement.style.display = 'block');
            document.getElementById('greenhouseDetailView').querySelector('button').style.display = 'none';
            document.getElementById('greenhouseDetailContent').style.display = 'none';
            selectedGreenhouse = null;
        }

        // Render crop chart for selected greenhouse
        function renderGreenhouseCropChart() {
            if (!selectedGreenhouse) return;

            const canvas = document.getElementById('greenhouseCropChart');
            const ctx = canvas.getContext('2d');

            // Destroy existing chart if any
            if (charts.greenhouseCrop) {
                charts.greenhouseCrop.destroy();
            }

            const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'];

            charts.greenhouseCrop = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: selectedGreenhouse.currentCrops.map(c => c.name),
                    datasets: [{
                        data: selectedGreenhouse.currentCrops.map(c => c.weight),
                        backgroundColor: colors.slice(0, selectedGreenhouse.currentCrops.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Render harvest records table
        function renderHarvestRecordsTable() {
            if (!selectedGreenhouse) return;

            const tbody = document.getElementById('harvestRecordsTable');
            const electricityRate = 5.5;
            const energyPerSqmPerDay = 2.8; // mock rate

            let html = '';
            selectedGreenhouse.currentCrops.forEach(crop => {
                const spec = traySpecs[crop.trayType];
                const totalArea = spec.area * crop.trayCount;
                const actualArea = crop.fullHoles ? totalArea : (crop.holesUsed / (spec.holes * crop.trayCount)) * totalArea;

                const energyKwh = (actualArea * crop.growthDays * energyPerSqmPerDay).toFixed(2);
                const kwhPerKg = (energyKwh / crop.weight).toFixed(2);

                html += `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 12px;">${crop.harvestDate}</td>
                        <td style="padding: 12px;">${crop.name}</td>
                        <td style="text-align: right; padding: 12px;">${crop.weight}</td>
                        <td style="text-align: right; padding: 12px;">${crop.trayCount}</td>
                        <td style="text-align: right; padding: 12px;">${actualArea.toFixed(2)}</td>
                        <td style="text-align: right; padding: 12px;">${crop.growthDays}</td>
                        <td style="text-align: right; padding: 12px;">${energyKwh}</td>
                        <td style="text-align: right; padding: 12px; font-weight: 600; color: #667eea;">${kwhPerKg}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // END NEW FUNCTIONS

        // Toggle holes input visibility
        function toggleHolesInput() {
            const checkbox = document.getElementById('fullHoles');
            const inputGroup = document.getElementById('holesInputGroup');
            const holesInput = document.getElementById('holesUsed');

            if (checkbox.checked) {
                inputGroup.style.display = 'none';
                holesInput.value = '';
                holesInput.removeAttribute('required');
            } else {
                inputGroup.style.display = 'block';
                holesInput.setAttribute('required', 'required');
            }

            updateTrayInfo();
        }

        // Update tray info when inputs change
        function updateTrayInfo() {
            const trayType = document.getElementById('trayType').value;
            const trayCount = parseInt(document.getElementById('trayCount').value) || 0;
            const fullHoles = document.getElementById('fullHoles').checked;
            const holesUsed = parseInt(document.getElementById('holesUsed').value) || 0;

            if (trayType && trayCount > 0) {
                const spec = traySpecs[trayType];

                // Calculate total area and holes
                const totalArea = spec.area * trayCount;
                const totalHoles = spec.holes * trayCount;

                // Calculate actual area based on holes used
                let actualArea = totalArea;
                let actualHoles = totalHoles;

                if (!fullHoles && holesUsed > 0) {
                    actualHoles = holesUsed;
                    if (holesUsed < totalHoles) {
                        actualArea = (holesUsed / totalHoles) * totalArea;
                    }
                }

                document.getElementById('totalArea').textContent = totalArea.toFixed(2) + ' ‡∏ï‡∏£.‡∏°.';
                document.getElementById('totalHoles').textContent = totalHoles.toLocaleString() + ' ‡∏´‡∏•‡∏∏‡∏°';

                if (!fullHoles && holesUsed > 0 && holesUsed < totalHoles) {
                    document.getElementById('actualArea').textContent = actualArea.toFixed(2) + ' ‡∏ï‡∏£.‡∏°. (' + holesUsed.toLocaleString() + ' ‡∏´‡∏•‡∏∏‡∏°)';
                    document.getElementById('actualArea').style.color = '#4CAF50';
                } else {
                    document.getElementById('actualArea').textContent = totalArea.toFixed(2) + ' ‡∏ï‡∏£.‡∏°. (‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏•‡∏∏‡∏°)';
                    document.getElementById('actualArea').style.color = '#667eea';
                }
            } else {
                document.getElementById('totalArea').textContent = '-- ‡∏ï‡∏£.‡∏°.';
                document.getElementById('totalHoles').textContent = '-- ‡∏´‡∏•‡∏∏‡∏°';
                document.getElementById('actualArea').textContent = '-- ‡∏ï‡∏£.‡∏°.';
            }

            // Trigger energy calculation when tray info changes
            calculateEnergy();
        }

        // Calculate energy preview in real-time
        function calculateEnergy() {
            const harvestDate = document.getElementById('harvestDate').value;
            const plantDate = document.getElementById('plantDate').value;
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const totalAreaText = document.getElementById('totalArea').textContent;

            // Extract area value from text
            const areaMatch = totalAreaText.match(/[\d.]+/);
            const totalArea = areaMatch ? parseFloat(areaMatch[0]) : 0;

            if (harvestDate && plantDate && weight > 0 && totalArea > 0) {
                const plant = new Date(plantDate);
                const harvest = new Date(harvestDate);
                const growthDays = Math.ceil((harvest - plant) / (1000 * 60 * 60 * 24));

                if (growthDays > 0) {
                    const mockEnergyPerSqmPerDay = 2.8; // kWh/‡∏ï‡∏£.‡∏°./‡∏ß‡∏±‡∏ô
                    const totalEnergyKwh = totalArea * growthDays * mockEnergyPerSqmPerDay;
                    const kwhPerKg = totalEnergyKwh / weight;
                    const kgPerKwh = weight / totalEnergyKwh;

                    document.getElementById('previewGrowthDays').textContent = growthDays + ' ‡∏ß‡∏±‡∏ô';
                    document.getElementById('previewTotalEnergy').textContent = totalEnergyKwh.toFixed(2) + ' kWh';
                    document.getElementById('previewKwhPerKg').textContent = kwhPerKg.toFixed(2) + ' kWh/kg';
                    document.getElementById('previewKgPerKwh').textContent = kgPerKwh.toFixed(3) + ' kg/kWh';
                    document.getElementById('energyPreview').style.display = 'block';
                } else {
                    document.getElementById('energyPreview').style.display = 'none';
                }
            } else {
                document.getElementById('energyPreview').style.display = 'none';
            }
        }

        // Modal functions
        function openInputModal() {
            document.getElementById('inputModal').style.display = 'block';
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('harvestDate').value = today;
        }

        function closeInputModal() {
            document.getElementById('inputModal').style.display = 'none';
            document.getElementById('productionForm').reset();
            // Reset checkbox to checked
            document.getElementById('fullHoles').checked = true;
            document.getElementById('holesInputGroup').style.display = 'none';
            // Reset calculated fields
            document.getElementById('totalArea').textContent = '-- ‡∏ï‡∏£.‡∏°.';
            document.getElementById('totalHoles').textContent = '-- ‡∏´‡∏•‡∏∏‡∏°';
            document.getElementById('actualArea').textContent = '-- ‡∏ï‡∏£.‡∏°.';
            document.getElementById('energyPreview').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('inputModal');
            if (event.target === modal) {
                closeInputModal();
            }
        }

        function submitProduction(event) {
            event.preventDefault();

            const trayType = document.getElementById('trayType').value;
            const trayCount = parseInt(document.getElementById('trayCount').value);
            const spec = traySpecs[trayType];

            const totalArea = (spec.area * trayCount).toFixed(2);
            const totalHoles = spec.holes * trayCount;

            const fullHoles = document.getElementById('fullHoles').checked;
            const holesUsed = fullHoles ? totalHoles : (parseInt(document.getElementById('holesUsed').value) || totalHoles);

            const formData = {
                harvestDate: document.getElementById('harvestDate').value,
                greenhouse: document.getElementById('greenhouse').value,
                trayType: trayType,
                trayTypeName: spec.name,
                trayCount: trayCount,
                totalArea: parseFloat(totalArea),
                totalHoles: totalHoles,
                fullHoles: fullHoles,
                holesUsed: holesUsed,
                vegetableType: document.getElementById('vegetableType').value,
                weight: parseFloat(document.getElementById('weight').value),
                plantDate: document.getElementById('plantDate').value
            };

            // Calculate growth days
            const plantDate = new Date(formData.plantDate);
            const harvestDate = new Date(formData.harvestDate);
            const growthDays = Math.ceil((harvestDate - plantDate) / (1000 * 60 * 60 * 24));

            // Calculate energy metrics (mock calculation based on area-time)
            const electricityRate = 5.5; // ‡∏ø/kWh
            const mockEnergyPerSqmPerDay = 2.8; // kWh/‡∏ï‡∏£.‡∏°./‡∏ß‡∏±‡∏ô (‡∏™‡∏°‡∏°‡∏ï‡∏¥)
            const totalEnergyKwh = formData.totalArea * growthDays * mockEnergyPerSqmPerDay;
            const kwhPerKg = totalEnergyKwh / formData.weight;
            const kgPerKwh = formData.weight / totalEnergyKwh;

            console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï:', {
                ...formData,
                growthDays: growthDays,
                totalEnergyKwh: totalEnergyKwh,
                kwhPerKg: kwhPerKg,
                kgPerKwh: kgPerKwh
            });

            // In real app, send to API
            const holesStatus = formData.fullHoles ? '‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏•‡∏∏‡∏°' : `${formData.holesUsed.toLocaleString()} ‡∏´‡∏•‡∏∏‡∏°`;
            alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å: ${getVegetableName(formData.vegetableType)}\n‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${formData.weight} kg\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏≤‡∏î: ${formData.trayCount} ‡∏ñ‡∏≤‡∏î (${formData.trayTypeName})\n‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${formData.totalArea} ‡∏ï‡∏£.‡∏°.\n‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏∏‡∏°: ${holesStatus}\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å: ${growthDays} ‡∏ß‡∏±‡∏ô\n\n--- ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ---\n‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏£‡∏ß‡∏°: ${totalEnergyKwh.toFixed(2)} kWh\n‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û: ${kwhPerKg.toFixed(2)} kWh/kg\n‡∏´‡∏£‡∏∑‡∏≠: ${kgPerKwh.toFixed(2)} kg/kWh`);

            closeInputModal();

            // Refresh dashboard (in real app, fetch new data from API)
            // updateDashboard();
        }

        function getVegetableName(value) {
            const names = {
                'lettuce': '‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°',
                'kale': '‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤',
                'spinach': '‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°',
                'basil': '‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤'
            };
            return names[value] || value;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('üöÄ Page loaded - initializing dashboard...');
            console.log('üìä Mock data:', mockData);

            try {
                console.log('üìà Initializing charts...');
                initCharts();
                console.log('‚úÖ Charts initialized');

                console.log('üìä Updating metrics...');
                updateMetrics();
                console.log('‚úÖ Metrics updated');

                console.log('üè≠ Rendering greenhouse summary cards...');
                renderGreenhouseSummaryCards();
                console.log('‚úÖ Greenhouse summary cards rendered');

                console.log('üå± Rendering vegetable cost table...');
                renderVegetableCostTable();
                console.log('‚úÖ Vegetable cost table rendered');

                console.log('‚úÖ Dashboard initialization complete!');
            } catch (error) {
                console.error('‚ùå Error during initialization:', error);
            }
        });
    </script>
</body>
</html>
